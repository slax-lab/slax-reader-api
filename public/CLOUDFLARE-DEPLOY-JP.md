# Cloudflare デプロイガイド

> **注意**: このプロジェクトは、KV、Durable Objects、Queue、Vectorize、Browser Render など、いくつかの高度な Cloudflare 機能に依存しています。デプロイ前に、デュアル通貨クレジットカードを持っていることを確認し、月額 $5 の Cloudflare Worker 有料プランを有効にする準備ができていることを確認してください。そうしないと、プロジェクトは正常に機能しません。

> **通知**: Cloudflare の自動構成スクリプトは現在開発中です。デプロイを試みる前に数日待つことをお勧めします。

## クイックデプロイ

以下のボタンをクリックしてデプロイプロセスを開始します：

[![Deploy to Cloudflare Workers](https://deploy.workers.cloudflare.com/button?paid=true)](https://deploy.workers.cloudflare.com/?url=https://github.com/YOURUSERNAME/YOURREPO&paid=true)

## デプロイプロセス

1. デプロイボタンをクリックすると、Cloudflare のウェブサイトにリダイレクトされます
2. Cloudflare アカウントにログインし、GitHub アカウントを認証します
3. Cloudflare がプロジェクトを自動的にデプロイします
4. デプロイ後、さまざまな環境変数とシークレットを構成する必要があります

## 環境変数の構成

デプロイ後、GitHub リポジトリに以下の環境変数を構成する必要があります：

![f5b4fe779867558eb3fe0db4108d6957.png](https://i.miji.bid/2025/03/05/f5b4fe779867558eb3fe0db4108d6957.png)

### 環境変数とシークレットの追加

1. デプロイ後、**Cloudflare Dashboard** に移動します
2. デプロイした Worker を選択します
3. **設定** > **変数** に移動します
4. 上記のすべての環境変数とシークレットを追加します：
   - 通常の環境変数には "**プレーンテキスト**" タイプを選択します
   - シークレットには "**暗号化**" タイプを選択します

### 有料プランの有効化

1. Cloudflare Dashboard でプロジェクトを見つけます
2. **設定** > **プラン** に移動します
3. **有料プラン** ($5/月) を選択します
4. 支払いプロセスを完了します

## デプロイの確認

構成後、Worker URL にアクセスしてデプロイ状態を確認します：

```
https://your-project.your-username.workers.dev
```

ページが正常に応答する場合、デプロイは成功です。

## 技術サポート

問題が発生した場合は、GitHub プロジェクトに Issue を提出してください。

---

詳細なデプロイガイドを参照して、さらに多くの構成手順とトラブルシューティング方法を確認してください。

## 構成の詳細

### 基本的な環境変数 (Vars)

これらの変数はプレーンテキストで表示でき、主に基本構成と公開情報に使用されます：

| 変数名             | 目的                                       | 取得方法                                |
| ------------------ | ------------------------------------------ | --------------------------------------- |
| IMAGE_PREFIX       | 画像プロキシインターフェース               | R2 に構成されたドメイン名を入力         |
| PROXY_IMAGE_PREFIX | クロスドメインおよび画像最適化のための画像プロキシサーバーアドレス | 1. https://<バックエンドドメイン>/static/image パス |
| FRONT_END_URL      | フロントエンドアプリケーションのアクセスアドレス | フロントエンドウェブサイトのドメイン    |

### 認証関連の構成

さまざまな認証サービスの構成、この部分はシークレットに記入する必要があります：

| 変数名                    | 目的                 | 取得方法                                                                        |
| ------------------------- | -------------------- | ------------------------------------------------------------------------------- |
| GOOGLE_CLIENT_ID_TEXT     | Google OAuth クライアント ID | 1. Google Cloud Console にアクセス<br>2. OAuth 2.0 クライアントを作成<br>3. Web アプリケーションクライアント ID を取得 |
| GOOGLE_CLIENT_SECRET_TEXT | Google OAuth シークレット | Google Cloud Console で対応するクライアントシークレットを取得                   |

### OpenAI 関連の構成

AI サービス関連の構成項目、この部分はシークレットに記入する必要があります：

| 変数名               | 目的                      | 取得方法                                                  |
| -------------------- | ------------------------- | --------------------------------------------------------- |
| OPENAI_GATEWAY       | Cloudflare AI Gateway アドレス | 1. Cloudflare コンソールで AI Gateway を有効にする<br>2. 専用ゲートウェイ URL を取得 |
| PROXY_OPENAI_GATEWAY | OpenAI API プロキシアドレス | 独自の API プロキシサーバーアドレスを構成                 |
| OPENAI_API_KEY       | OpenAI API キー            | 1. OpenAI アカウントに登録<br>2. API 設定ページでキーを作成 |
| JINA_API_KEY         | Jina AI サービスキー       | Jina Cloud アカウントに登録し、API キーを作成              |

### Telegram ボットの構成

| 変数名                   | 目的            | 取得方法                                          |
| ------------------------ | --------------- | ------------------------------------------------- |
| SLAX_READER_BOT_NAME     | ボットのユーザー名 | 1. BotFather を使用してボットを作成<br>2. ボットのユーザー名を設定 |
| SLAX_READER_BOT_ID       | ボットの数値 ID | BotFather から取得するか、API から取得             |
| SLAX_READER_BOT_API_ROOT | ボット API サーバー | Telegram Bot API サーバーアドレスを構成            |
| TELEGRAM_BOT_TOKEN       | ボットのアクセス トークン | BotFather でボットを作成する際に取得               |

### 検索サービスの構成

| 変数名                   | 目的              | 取得方法                                                       |
| ------------------------ | ----------------- | -------------------------------------------------------------- |
| GOOGLE_SEARCH_KEY        | Google 検索 API キー | 1. Google Cloud Console で Custom Search API を有効にする<br>2. API キーを作成 |
| GOOGLE_SEARCH_ENAGINE_ID | カスタム検索エンジン ID | 1. Programmable Search Engine にアクセス<br>2. 検索エンジンを作成し、ID を取得 |

### セキュリティ関連の構成

| 変数名          | 目的        | 取得方法               |
| --------------- | ----------- | ---------------------- |
| HASH_IDS_SALT   | ID 混淆ソルト | ランダムな文字列を生成 |
| JWT_SECRET_TEXT | JWT 署名キー | 十分に長いランダムな文字列を生成 |

### その他のサービス構成

| 変数名          | 目的             | 取得方法                                       |
| --------------- | ---------------- | ---------------------------------------------- |
| APIFY_API_TOKEN | ウェブスクレイピングサービス トークン | 1. Apify アカウントに登録<br>2. アカウント設定で API トークンを作成 |

## 構成の優先順位と考慮事項

1. コアサービスの構成（必須）：

   - Cloudflare Workers 環境変数
   - OpenAI API 構成
   - データベースとストレージの構成
   - 基本的な認証キー（JWT、Hash）

2. 機能サービスの構成（必要に応じて）：

   - ソーシャルログイン（Google、Apple）
   - Telegram ボット
   - 検索サービス
   - ウェブスクレイピング
   - プッシュ通知

### セキュリティの推奨事項

1. すべてのシークレット構成は Cloudflare の暗号化環境変数機能を使用する必要があります
2. 重要なキーを定期的にローテーションする
3. 最小権限の原則に従ってサードパーティサービスを構成する
4. すべてのキーと証明書ファイルを適切に保管する

### コストの考慮事項

1. Cloudflare Workers：基本 $5/月
2. OpenAI API：使用量に応じて課金されるため、制限を設定することをお勧めします
3. ほとんどの他のサービスは無料プランまたは試用クォータを提供しています

## 必要な Cloudflare サービス

このプロジェクトには、複数の高度な Cloudflare サービスが必要です。すべてのサービス構成を正しく完了する必要があり、アプリケーションが正常に動作することを確認してください。以下は、サービスの有効化と構成の詳細なチュートリアルです：

### D1 データベース

2 つのデータベースインスタンスを作成する必要があります：

**構成手順**：

1. Cloudflare Dashboard で **Workers & Pages** > **D1** に移動します
2. **データベースの作成** ボタンをクリックします
3. 2 つのデータベースを順番に作成します：
   - `slax-reader-backend`（メインデータベース）
   - `slax-reader-backend-fulltext`（全文検索データベース）
4. 作成後、各データベースの ID を記録し、config/prod.toml に記入します
5. 開発環境の場合、対応するプレビューデータベースを作成します

### R2 ストレージバケット

**構成手順**：

1. Cloudflare Dashboard で **R2** に移動します
2. **バケットの作成** ボタンをクリックします
3. 2 つのバケットを作成します：
   - `slax-reader-backend`（本番環境）
   - `slax-reader-backend-preview`（プレビュー環境）
4. 各バケットについて、以下の設定を構成します：
   - 公共アクセス：必要に応じて設定
   - CORS ルール：フロントエンドドメインからのアクセスを許可
   - ライフサイクルルール：必要に応じて設定

### Vectorize ベクトルデータベース

**構成手順**：

1. Cloudflare Dashboard で **Vectorize** に移動します
2. **インデックスの作成** ボタンをクリックします
3. 5 つのベクトルインデックスを順番に作成します：
   - インデックス名：`bookmark-1` から `bookmark-5` まで
   - 各インデックスの構成：
     - 次元：1024（OpenAI ベクトルと互換性あり）
     - 距離メトリック：コサイン類似度
     - メタデータフィルタリング：有効

### Durable Objects

**構成手順**：

1. Durable Objects は Worker をデプロイする際に自動的に作成されます
2. `wrangler.toml` ファイルにすべての Durable Objects クラスが正しく定義されていることを確認します
3. Worker デプロイ後、Cloudflare Dashboard の **Durable Objects** セクションでこれらのオブジェクトを表示および管理できます

### キューサービス (Queues)

以下のコンシューマーキューを構成する必要があります：

**構成手順**：

1. Cloudflare Dashboard で **Workers & Pages** > **Queues** に移動します
2. **キューの作成** ボタンをクリックします
3. 以下のキューを順番に作成します：
   - `slax-reader-parser-twitter`：Twitter コンテンツ解析を処理
   - `slax-reader-parser-fetch-retry-prod`：ウェブスクレイピングの再試行を処理
   - `slax-reader-parser-stripe`：支払い関連の操作を処理
   - `slax-reader-migrate-from-other`：他のサービスからのデータインポートを処理
